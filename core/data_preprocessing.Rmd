---
title:  Data Preprocessing
author: Dimitri Leandro
date:   March, 2023
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 3
    number_sections: true
    code_folding: show
---

# Getting started

## Imports

```{r message=FALSE, warning=FALSE}
library(jsonlite)
library(stringr)
library(purrr)
library(dplyr)
library(lubridate)
```

## Functions definitions

```{r}
getActivityDataFrame <- function(
    df,
    activity,
    columnsPrefix = 'timelineObjects.activitySegment.'
){
  # getting rows where activity
  df_activity <- df[
    df$timelineObjects.activitySegment.activityType==activity & 
      !is.na(df$timelineObjects.activitySegment.activityType),
  ]
  
  # removing columns where all rows are null or na
  df_activity <- df_activity[
    colSums(is.na(df_activity) | df_activity=='NULL') != nrow(df_activity)
  ]
  
  # renaming columns by removing prefix
  colnames(df_activity) <- map(
    colnames(df_activity),
    function(col) str_replace(col, columnsPrefix, '')
  )
  
  return(df_activity)
}
```

```{r}
processActivityColumns <- function(
    df_activity, 
    column_mappings
){
  # renaming and selecting columns based on collection  
  df_activity <- df_activity %>%
    rename(column_mappings) %>%
    select(all_of(names(column_mappings)))

  # converting start timestamp to berlin timezone
  df_activity$startTimestamp <- as.POSIXct(
    x      = df_activity$startTimestamp,
    format = '%FT%T',
    tz     = 'Europe/Berlin'
  ) + hours(2)
  
  # converting end timestamp to berlin timezone
  df_activity$endTimestamp <- as.POSIXct(
    x      = df_activity$endTimestamp,
    format = '%FT%T',
    tz     = 'Europe/Berlin'
  ) + hours(2)
  
  # converting meters to kilometers
  df_activity$kilometers <- df_activity$kilometers/1000
  
  # duration of activity in hours
  df_activity$hours <- as.numeric(
    difftime(
      df_activity$endTimestamp,
      df_activity$startTimestamp,
      units = 'hours'
    )
  )
  
  # speed in km/h
  df_activity$speed <- df_activity$kilometers / df_activity$hours
  
  # categorical start timestamp
  df_activity$startTimeCategorical <- cut(
    x              = hour(df_activity$startTimestamp), 
    breaks         = hour(hm('00:00', '06:00', '12:00', '18:00', '23:59')), 
    labels         = c('Night', 'Morning', 'Afternoon', 'Evening'), 
    include.lowest = TRUE
  )
  
  return(df_activity)
}
```

# Understanding the data structure

## Activity Segment 

```{r}
# reading simple subsample json
df <- as.data.frame(
  fromJSON(
    txt = '../dataset/raw/simple_subsample.json',
    flatten = TRUE
  )
)

# mapping new names to the columns I'd like to keep
column_mappings <- c(
  'activityType'   = 'activityType',
  'startTimestamp' = 'duration.startTimestamp',
  'endTimestamp'   = 'duration.endTimestamp',
  'kilometers'     = 'waypointPath.distanceMeters'
)
```

### Cycling

```{r}
# getting only cycling samples and its columns
df_cycling <- getActivityDataFrame(df, 'CYCLING')

# formatting columns
df_cycling <- processActivityColumns(df_cycling, column_mappings)

# how it looks like
head(df_cycling)
```

### Walking

```{r}
# getting only walking samples and its columns
df_walking <- getActivityDataFrame(df, 'WALKING')

# formatting columns
df_walking <- processActivityColumns(df_walking, column_mappings)

# how it looks like
head(df_walking)
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}
write.csv(
  x         = df_cycling, 
  file      = '../dataset/test.csv', 
  row.names = FALSE
)
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}
# getting only cycling samples and its columns
df_cycling <- getDefinedActivityDataFrame(df, 'CYCLING')

# getting only walking samples and its columns
df_walking <- getDefinedActivityDataFrame(df, 'WALKING')

# getting only in_train samples and its columns
df_train <- getDefinedActivityDataFrame(df, 'IN_TRAIN')

# getting only in_bus samples and its columns
df_bus <- getDefinedActivityDataFrame(df, 'IN_BUS')

colnames(df_bus)
```
