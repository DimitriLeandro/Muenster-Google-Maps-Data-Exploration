---
title:  Data Preprocessing
author: Dimitri Leandro
date:   March, 2023
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 3
    number_sections: true
    code_folding: show
---

# Getting started

## Imports

```{r message=FALSE, warning=FALSE}
library(jsonlite)
library(stringr)
library(purrr)
library(dplyr)
library(lubridate)
```

## Functions definitions

```{r}
getDefinedActivityDataFrame <- function(
    df,
    activity,
    columnsPrefix = 'timelineObjects.activitySegment.'
){
  # getting rows where activity
  df_activity <- df[
    df$timelineObjects.activitySegment.activityType==activity & 
      !is.na(df$timelineObjects.activitySegment.activityType),
  ]
  
  # removing columns where all rows are null or na
  df_activity <- df_activity[
    colSums(is.na(df_activity) | df_activity=='NULL') != nrow(df_activity)
  ]
  
  # renaming columns by removing prefix
  colnames(df_activity) <- map(
    colnames(df_activity),
    function(col) str_replace(col, columnsPrefix, '')
  )
  
  return(df_activity)
}
```

# Understanding the data structure

```{r}
# reading simple subsample json
df <- as.data.frame(
  fromJSON(
    txt = '../dataset/raw/simple_subsample.json',
    flatten = TRUE
  )
)
```

## Cycling

```{r}
# getting only cycling samples and its columns
df_cycling <- getDefinedActivityDataFrame(df, 'CYCLING')
# colnames(df_cycling)

# mapping new names to the columns I'd like to keep
column_mappings <- c(
  'activityType'   = 'activityType',
  'startTimestamp' = 'duration.startTimestamp',
  'endTimestamp'   = 'duration.endTimestamp',
  'kilometers'     = 'waypointPath.distanceMeters'
)

df_cycling <- df_cycling %>%
  rename(column_mappings) %>%
  select(all_of(names(column_mappings)))

df_cycling %>% head()
```

```{r}

df_cycling$startTimestamp <- as.POSIXct(
  x      = df_cycling$startTimestamp,
  format = '%FT%T',
  tz     = 'Europe/Berlin'
) + hours(2)

df_cycling$endTimestamp <- as.POSIXct(
  x      = df_cycling$endTimestamp,
  format = '%FT%T',
  tz     = 'Europe/Berlin'
) + hours(2)

df_cycling %>% head()
```

```{r}
df_cycling$kilometers <- df_cycling$kilometers/1000
df_cycling %>% head()
```

```{r}
df_cycling$hours <- as.numeric(
  difftime(
    df_cycling$endTimestamp,
    df_cycling$startTimestamp,
    units = 'hours'
  )
)

df_cycling$speed <- df_cycling$kilometers / df_cycling$hours 

df_cycling %>% head()
```

```{r}
df_cycling$startTimeCategorical <- cut(
  x              = hour(df_cycling$startTimestamp), 
  breaks         = hour(hm('00:00', '06:00', '12:00', '18:00', '23:59')), 
  labels         = c('Night', 'Morning', 'Afternoon', 'Evening'), 
  include.lowest = TRUE
)

df_cycling %>% head()
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}
write.csv(
  x         = df_cycling, 
  file      = '../dataset/test.csv', 
  row.names = FALSE
)
```

```{r}
?write.csv
```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}
# getting only cycling samples and its columns
df_cycling <- getDefinedActivityDataFrame(df, 'CYCLING')

# getting only walking samples and its columns
df_walking <- getDefinedActivityDataFrame(df, 'WALKING')

# getting only in_train samples and its columns
df_train <- getDefinedActivityDataFrame(df, 'IN_TRAIN')

# getting only in_bus samples and its columns
df_bus <- getDefinedActivityDataFrame(df, 'IN_BUS')

colnames(df_bus)
```
